name: Deploy to Render and Add Deployed URL

on:
  pull_request:
    types:
      - opened

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Check Out Code
        uses: actions/checkout@v2

      - name: Set Up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 14

      - name: Install Dependencies
        run: npm install

      - name: Build React App
        run: |
          cd admin
          npm install
          npm run build

      - name: Serve React App Locally
        run: |
          npm install -g serve
          serve -s admin/build &
          sleep 3 # Wait for the server to start

      - name: Get Deployed URL
        id: deployed_url
        run: |
          API_TOKEN="${{ secrets.RENDER_API_TOKEN }}"
          BRANCH="${{ github.head_ref }}"
          DEPLOYMENT_INFO=$(curl -s -H "Authorization: Bearer $API_TOKEN" "https://api.render.com/v1/branches/$BRANCH")
          DEPLOYED_URL=$(echo "$DEPLOYMENT_INFO" | jq -r .data.url)
          echo "Deployed URL: $DEPLOYED_URL"
          echo "::set-output name=deployed_url::$DEPLOYED_URL"

      - name: Create Status Check
        run: |
          API_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          DEPLOYED_URL="${{ steps.deployed_url.outputs.deployed_url }}"
          curl -X POST -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: Bearer $API_TOKEN" \
          "https://api.github.com/repos/$GITHUB_REPOSITORY/statuses/$GITHUB_SHA" \
          -d '{
            "state": "success",
            "description": "Deployed URL",
            "context": "deployed-url",
            "target_url": "'"$DEPLOYED_URL"'"
          }'
